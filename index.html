<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BodyScan Â· AI Measurements</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --body-scale: 1; /* avatar waist scale */
    }

    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }

    button, input, textarea, select {
      font: inherit;
    }

    .app {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      max-width: 900px;
      margin: 0 auto;
      background: #020617;
    }

    header {
      padding: 1rem 1.2rem 0.5rem;
      border-bottom: 1px solid #111827;
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.08em;
    }
    header h1 span {
      color: #22c55e;
    }
    header p {
      margin: 0.25rem 0 0.5rem;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    main {
      flex: 1;
      padding: 0.5rem 1rem 4rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .card {
      background: #020617;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      padding: 0.9rem 1rem 1rem;
    }

    .card h2 {
      margin: 0 0 0.5rem;
      font-size: 1.1rem;
    }

    .card h3 {
      margin: 0.8rem 0 0.4rem;
      font-size: 0.9rem;
    }

    .hint {
      font-size: 0.78rem;
      color: #9ca3af;
    }

    .section-header-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.3rem;
    }
    .section-header-line small {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .primary {
      border: none;
      background: #22c55e;
      color: #022c22;
      border-radius: 999px;
      padding: 0.5rem 1.2rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
    }
    .primary:active {
      transform: scale(0.98);
    }

    .secondary {
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      border-radius: 999px;
      padding: 0.45rem 1rem;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .secondary:active {
      transform: scale(0.98);
    }

    /* DASHBOARD METRICS */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.6rem;
      margin-top: 0.6rem;
    }

    .metric-card {
      padding: 0.6rem;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, #022c22, #020617 55%);
    }
    .metric-card h4 {
      margin: 0;
      font-size: 0.8rem;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .metric-card .value {
      margin-top: 0.25rem;
      font-size: 1.2rem;
      font-weight: 600;
    }
    .metric-card .unit {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-left: 0.15rem;
    }
    .metric-card .delta {
      margin-top: 0.25rem;
      font-size: 0.75rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.15rem;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
    }
    .delta.up {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }
    .delta.down {
      background: rgba(248, 113, 113, 0.18);
      color: #f87171;
    }
    .delta.flat {
      background: rgba(148, 163, 184, 0.18);
      color: #9ca3af;
    }

    /* AVATAR + BODY MAP */
    .avatar-card {
      display: grid;
      grid-template-columns: minmax(0, 180px) minmax(0, 1fr);
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.4rem;
    }

    .avatar-wrapper {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0.4rem;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top, #0f172a, #020617);
      min-height: 170px;
    }

    .avatar {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.1rem;
    }

    .avatar-head {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #0f172a;
      border: 2px solid #22c55e;
    }

    .avatar-body {
      width: calc(40px * var(--body-scale));
      height: 90px;
      border-radius: 24px;
      background: linear-gradient(to bottom, #16a34a, #22c55e);
      transition: width 0.25s ease-out;
      position: relative;
    }

    .avatar-body::before,
    .avatar-body::after {
      content: "";
      position: absolute;
      top: 12px;
      width: 10px;
      height: 42px;
      border-radius: 999px;
      background: #16a34a;
    }
    .avatar-body::before { left: -8px; }
    .avatar-body::after { right: -8px; }

    /* Sex variants */
    .avatar-neutral .avatar-body {
      background: linear-gradient(to bottom, #16a34a, #22c55e);
    }
    .avatar-male .avatar-body {
      background: linear-gradient(to bottom, #22c55e, #16a34a);
      border-radius: 20px;
    }
    .avatar-female .avatar-body {
      background: linear-gradient(to bottom, #f97316, #fb7185);
      border-radius: 28px;
    }
    .avatar-male .avatar-head {
      border-color: #22c55e;
    }
    .avatar-female .avatar-head {
      border-color: #fb7185;
    }

    .avatar-stats {
      font-size: 0.8rem;
      color: #d1d5db;
    }
    .avatar-stats strong {
      font-size: 0.85rem;
    }

    .avatar-label {
      position: absolute;
      font-size: 0.7rem;
      color: #e5e7eb;
      white-space: nowrap;
    }
    .avatar-label::before {
      content: "";
      position: absolute;
      top: 50%;
      width: 18px;
      border-top: 1px solid #4b5563;
    }
    .avatar-label.left {
      left: 4px;
      text-align: left;
    }
    .avatar-label.left::before {
      left: 100%;
      margin-left: 2px;
    }
    .avatar-label.right {
      right: 4px;
      text-align: right;
    }
    .avatar-label.right::before {
      right: 100%;
      margin-right: 2px;
    }

    /* vertical positioning */
    #label-shoulders { top: 20px; }
    #label-chest     { top: 55px; }
    #label-waist     { top: 90px; }
    #label-hips      { top: 55px; }
    #label-thighs    { top: 95px; }
    #label-calves    { top: 130px; }

    /* FORMS */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 0.6rem;
    }
    .form-row {
      display: flex;
      flex-direction: column;
      gap: 0.18rem;
      margin-bottom: 0.4rem;
    }
    label {
      font-size: 0.78rem;
      color: #d1d5db;
    }
    input[type="number"],
    input[type="date"],
    input[type="text"],
    textarea,
    select {
      border-radius: 0.6rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      padding: 0.4rem 0.55rem;
      font-size: 0.85rem;
    }
    input::placeholder,
    textarea::placeholder {
      color: #6b7280;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    input[type="file"] {
      font-size: 0.75rem;
    }

    /* HISTORY TABLE */
    .table-wrapper {
      overflow-x: auto;
      margin-top: 0.5rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    th, td {
      padding: 0.4rem 0.25rem;
      border-bottom: 1px solid #111827;
      text-align: left;
    }
    thead {
      background: #020617;
    }
    tbody tr {
      cursor: pointer;
    }
    tbody tr:hover {
      background: #020617;
    }
    .empty-row td {
      text-align: center;
      color: #6b7280;
      padding: 0.6rem;
      cursor: default;
    }

    /* DETAIL VIEW */
    .measurements-list {
      list-style: none;
      padding: 0;
      margin: 0.3rem 0 0.4rem;
      font-size: 0.8rem;
    }
    .measurements-list li {
      margin-bottom: 0.15rem;
    }

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.4rem;
      margin-top: 0.4rem;
    }
    figure {
      margin: 0;
      padding: 0.3rem;
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      background: #020617;
    }
    figure img {
      width: 100%;
      border-radius: 0.4rem;
      object-fit: cover;
      max-height: 240px;
    }
    figure figcaption {
      margin-top: 0.2rem;
      font-size: 0.75rem;
      color: #9ca3af;
      text-align: center;
    }

    /* NAVBAR */
    nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-width: 900px;
      margin: 0 auto;
      border-top: 1px solid #111827;
      background: rgba(2, 6, 23, 0.96);
      backdrop-filter: blur(16px);
    }
    .nav-inner {
      display: flex;
      justify-content: space-around;
      padding: 0.25rem 0.5rem 0.4rem;
    }
    .nav-btn {
      flex: 1;
      border: none;
      background: none;
      color: #6b7280;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.1rem;
      padding: 0.3rem 0;
      font-size: 0.75rem;
      cursor: pointer;
    }
    .nav-btn span.icon {
      font-size: 1rem;
    }
    .nav-btn.active {
      color: #22c55e;
      font-weight: 600;
    }

    .hidden { display: none !important; }

    #ai-status {
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1><span>BODY</span>SCAN</h1>
    <p id="header-subtitle">AI-assisted body tracking Â· Data stays on this device.</p>
  </header>

  <main>
    <!-- DASHBOARD -->
    <section id="section-dashboard" class="card">
      <div class="section-header-line">
        <h2>Dashboard</h2>
        <button id="btn-dashboard-newscan" class="primary">New Scan â†’</button>
      </div>
      <p class="hint" id="last-scan-text">No scans yet. Add your first scan to get started.</p>

      <div class="avatar-card">
        <div class="avatar-wrapper">
          <div id="avatar-figure" class="avatar avatar-neutral">
            <div class="avatar-head"></div>
            <div class="avatar-body"></div>
          </div>

          <!-- body-map labels -->
          <div class="avatar-label left" id="label-shoulders">Shoulders: â€”</div>
          <div class="avatar-label left" id="label-chest">Chest: â€”</div>
          <div class="avatar-label left" id="label-waist">Waist: â€”</div>

          <div class="avatar-label right" id="label-hips">Hips: â€”</div>
          <div class="avatar-label right" id="label-thighs">Thighs: â€”</div>
          <div class="avatar-label right" id="label-calves">Calves: â€”</div>
        </div>
        <div class="avatar-stats">
          <strong>Latest body outline</strong><br />
          <span id="avatar-measurements" class="hint">
            Once you add a scan, this silhouette and labels update to match your latest measurements.
          </span>
        </div>
      </div>

      <div class="metrics-grid" id="metrics-grid"></div>

      <h3>Progress Summary</h3>
      <p class="hint" id="progress-summary">
        Once you have at least two scans, you'll see changes in weight, waist, and body fat here.
      </p>
    </section>

    <!-- NEW SCAN -->
    <section id="section-newscan" class="card hidden">
      <div class="section-header-line">
        <h2>New Scan</h2>
        <small class="hint">Use your usual lighting, pose, and distance for consistency.</small>
      </div>

      <form id="scan-form">
        <div class="form-row">
          <label for="scan-date">Date</label>
          <input type="date" id="scan-date" required />
        </div>
        <div class="form-grid">
          <div class="form-row">
            <label for="scan-time">Time (optional)</label>
            <input type="text" id="scan-time" placeholder="e.g. 09:30 AM" />
          </div>
          <div class="form-row">
            <label for="scan-weight">Weight</label>
            <input type="number" id="scan-weight" step="0.1" placeholder="lbs or kg" />
          </div>
          <div class="form-row">
            <label for="scan-bodyfat">Body fat %</label>
            <input type="number" id="scan-bodyfat" step="0.1" placeholder="optional" />
          </div>
          <div class="form-row">
            <label for="scan-muscle">Muscle mass</label>
            <input type="number" id="scan-muscle" step="0.1" placeholder="optional" />
          </div>
        </div>

        <h3>Measurements</h3>
        <p class="hint">
          You can fill these manually from tape/Evolt or let the AI suggest values from your photos.
        </p>
        <div class="form-grid">
          <div class="form-row">
            <label for="measure-chest">Chest</label>
            <input type="number" id="measure-chest" step="0.1" placeholder="in / cm" />
          </div>
          <div class="form-row">
            <label for="measure-shoulders">Shoulders</label>
            <input type="number" id="measure-shoulders" step="0.1" placeholder="in / cm" />
          </div>
          <div class="form-row">
            <label for="measure-waist">Waist</label>
            <input type="number" id="measure-waist" step="0.1" placeholder="in / cm" />
          </div>
          <div class="form-row">
            <label for="measure-hips">Hips</label>
            <input type="number" id="measure-hips" step="0.1" placeholder="in / cm" />
          </div>
          <div class="form-row">
            <label for="measure-arms">Arms</label>
            <input type="number" id="measure-arms" step="0.1" placeholder="in / cm" />
          </div>
          <div class="form-row">
            <label for="measure-thighs">Thighs</label>
            <input type="number" id="measure-thighs" step="0.1" placeholder="in / cm" />
          </div>
          <div class="form-row">
            <label for="measure-calves">Calves</label>
            <input type="number" id="measure-calves" step="0.1" placeholder="in / cm" />
          </div>
        </div>

        <h3>Photos</h3>
        <p class="hint">
          AI needs at least front + side. Try to keep the camera at about chest height, neutral pose, no flexing.
        </p>
        <div class="form-grid">
          <div class="form-row">
            <label for="photo-front">Front</label>
            <input type="file" id="photo-front" accept="image/*" />
          </div>
          <div class="form-row">
            <label for="photo-side">Side</label>
            <input type="file" id="photo-side" accept="image/*" />
          </div>
          <div class="form-row">
            <label for="photo-back">Back</label>
            <input type="file" id="photo-back" accept="image/*" />
          </div>
          <div class="form-row">
            <label for="photo-angle">45Â° / three-quarter</label>
            <input type="file" id="photo-angle" accept="image/*" />
          </div>
        </div>

        <div class="form-row">
          <button type="button" id="btn-ai-analyze" class="secondary">
            Analyze Photos with AI
          </button>
          <p id="ai-status" class="hint"></p>
        </div>

        <h3>Notes</h3>
        <div class="form-row">
          <textarea id="scan-notes" placeholder="Training, diet, stress, sleep, cravings, etc."></textarea>
        </div>

        <button type="submit" class="primary">Save Scan</button>
      </form>
    </section>

    <!-- HISTORY -->
    <section id="section-history" class="card hidden">
      <div class="section-header-line">
        <h2>History</h2>
        <small class="hint">Tap a row to view full details and photos.</small>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th>Date</th>
            <th>Weight</th>
            <th>Waist</th>
            <th>Body fat</th>
            <th>Notes</th>
          </tr>
          </thead>
          <tbody id="history-body"></tbody>
        </table>
      </div>
    </section>

    <!-- DETAIL VIEW -->
    <section id="section-detail" class="card hidden">
      <div class="section-header-line">
        <h2>Scan Details</h2>
        <button id="btn-detail-close" class="secondary">Close</button>
      </div>
      <p id="detail-summary" class="hint"></p>

      <div class="form-grid">
        <div>
          <h3>Measurements</h3>
          <ul class="measurements-list" id="detail-measurements"></ul>
          <h3>Notes</h3>
          <p id="detail-notes"></p>
        </div>
        <div>
          <h3>Photos</h3>
          <div class="photo-grid">
            <figure>
              <img id="detail-front" alt="Front view" />
              <figcaption>Front</figcaption>
            </figure>
            <figure>
              <img id="detail-side" alt="Side view" />
              <figcaption>Side</figcaption>
            </figure>
            <figure>
              <img id="detail-back" alt="Back view" />
              <figcaption>Back</figcaption>
            </figure>
            <figure>
              <img id="detail-angle" alt="45Â° view" />
              <figcaption>45Â°</figcaption>
            </figure>
          </div>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="section-profile" class="card hidden">
      <div class="section-header-line">
        <h2>Profile</h2>
        <small class="hint">Used to calculate BMI and slightly adjust the avatar shape.</small>
      </div>

      <form id="profile-form">
        <div class="form-row">
          <label for="profile-units">Units</label>
          <select id="profile-units">
            <option value="metric">Metric (kg, cm)</option>
            <option value="imperial">Imperial (lb, in)</option>
          </select>
        </div>
        <div class="form-grid">
          <div class="form-row">
            <label for="profile-height">Height</label>
            <input type="number" id="profile-height" step="0.1" placeholder="cm or in" />
          </div>
          <div class="form-row">
            <label for="profile-age">Age</label>
            <input type="number" id="profile-age" />
          </div>
          <div class="form-row">
            <label for="profile-sex">Sex</label>
            <select id="profile-sex">
              <option value="">Neutral / prefer not to say</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <label for="profile-goal">Goal (optional)</label>
          <input type="text" id="profile-goal" placeholder="Example: Lean 190 lbs with visible abs" />
        </div>
        <button type="submit" class="primary">Save Profile</button>
      </form>

      <h3>Mindset reminder</h3>
      <p class="hint">
        This app tracks numbers and photos, not your worth. If tracking ever makes you feel worse,
        pause the data and focus on habits, sleep, and mental health first.
      </p>
    </section>
  </main>

  <nav>
    <div class="nav-inner">
      <button class="nav-btn active" data-target="dashboard">
        <span class="icon">ðŸ“Š</span>
        Dashboard
      </button>
      <button class="nav-btn" data-target="newscan">
        <span class="icon">âž•</span>
        New Scan
      </button>
      <button class="nav-btn" data-target="history">
        <span class="icon">ðŸ•‘</span>
        History
      </button>
      <button class="nav-btn" data-target="profile">
        <span class="icon">ðŸ‘¤</span>
        Profile
      </button>
    </div>
  </nav>
</div>

<script>
  // ===== CONFIG =====
  const API_URL = "https://ai-body-measurement-tracker.onrender.com/api/measure";

  const STORAGE_SCANS = "bodyscan_entries_v2";
  const STORAGE_PROFILE = "bodyscan_profile_v1";

  let scans = [];
  let profile = { units: "metric", height: null, age: null, sex: "", goal: "" };

  // ===== LOAD / SAVE =====
  function loadData() {
    const savedScans = localStorage.getItem(STORAGE_SCANS);
    const savedProfile = localStorage.getItem(STORAGE_PROFILE);
    if (savedScans) {
      try { scans = JSON.parse(savedScans); } catch { scans = []; }
    }
    if (savedProfile) {
      try { profile = { ...profile, ...JSON.parse(savedProfile) }; } catch {}
    }
  }
  function saveScans() {
    localStorage.setItem(STORAGE_SCANS, JSON.stringify(scans));
  }
  function saveProfile() {
    localStorage.setItem(STORAGE_PROFILE, JSON.stringify(profile));
  }

  // ===== HELPERS =====
  function formatDelta(current, previous, goodWhenDown = true) {
    if (previous == null || isNaN(previous) || previous === 0) return { text: "â€”", cls: "flat" };
    if (current == null || isNaN(current)) return { text: "â€”", cls: "flat" };
    const diff = current - previous;
    const pct = (diff / previous) * 100;
    const rounded = pct.toFixed(1);
    if (Math.abs(pct) < 0.1) return { text: "0.0%", cls: "flat" };
    const arrow = pct < 0 ? "â†“" : "â†‘";
    const cls = (pct < 0 && goodWhenDown) || (pct > 0 && !goodWhenDown) ? "down" : "up";
    return { text: `${arrow} ${Math.abs(rounded)}%`, cls };
  }

  function computeBMI(weight, height, units) {
    if (!weight || !height) return null;
    if (units === "metric") {
      const m = height / 100;
      return weight / (m * m);
    } else {
      return (703 * weight) / (height * height);
    }
  }

  function shortNotes(notes) {
    if (!notes) return "";
    return notes.length > 35 ? notes.slice(0, 32) + "..." : notes;
  }

  function readFileAsDataURL(file) {
    return new Promise((resolve) => {
      if (!file) return resolve(null);
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = () => resolve(null);
      reader.readAsDataURL(file);
    });
  }

  function updateAvatar(measurements) {
    const units = profile.units || "metric";
    const unitLabel = units === "metric" ? "cm" : "in";
    const avatarFigure = document.getElementById("avatar-figure");

    avatarFigure.classList.remove("avatar-neutral", "avatar-male", "avatar-female");
    if (profile.sex === "male") avatarFigure.classList.add("avatar-male");
    else if (profile.sex === "female") avatarFigure.classList.add("avatar-female");
    else avatarFigure.classList.add("avatar-neutral");

    if (!measurements) {
      document.documentElement.style.setProperty("--body-scale", "1");
      document.getElementById("avatar-measurements").textContent =
        "Add a scan with measurements to see this body map update.";
      ["shoulders", "chest", "waist", "hips", "thighs", "calves"].forEach((key) => {
        const id = "label-" + key;
        const el = document.getElementById(id);
        if (el) el.textContent = key.charAt(0).toUpperCase() + key.slice(1) + ": â€”";
      });
      return;
    }

    const shoulders = measurements.shoulders;
    const chest = measurements.chest;
    const waist = measurements.waist;
    const hips = measurements.hips;
    const thighs = measurements.thighs;
    const calves = measurements.calves;

    const baseWaist = units === "metric" ? 90 : 35;
    const scale = waist
      ? Math.max(0.7, Math.min(1.3, waist / baseWaist))
      : 1;
    document.documentElement.style.setProperty("--body-scale", scale.toFixed(2));

    function label(id, name, value) {
      const el = document.getElementById(id);
      if (!el) return;
      if (value == null || isNaN(value)) {
        el.textContent = `${name}: â€”`;
      } else {
        el.textContent = `${name}: ${value} ${unitLabel}`;
      }
    }

    label("label-shoulders", "Shoulders", shoulders);
    label("label-chest", "Chest", chest);
    label("label-waist", "Waist", waist);
    label("label-hips", "Hips", hips);
    label("label-thighs", "Thighs", thighs);
    label("label-calves", "Calves", calves);

    const summaryParts = [];
    if (waist != null) summaryParts.push(`waist ${waist} ${unitLabel}`);
    if (chest != null) summaryParts.push(`chest ${chest} ${unitLabel}`);
    if (hips != null) summaryParts.push(`hips ${hips} ${unitLabel}`);
    document.getElementById("avatar-measurements").textContent =
      summaryParts.length
        ? `Silhouette scaled from ${summaryParts.join(" Â· ")}.`
        : "Body map updated from your latest scan.";
  }

  // ===== RENDER =====
  function renderDashboard() {
    const lastScanText = document.getElementById("last-scan-text");
    const metricsGrid = document.getElementById("metrics-grid");
    const summary = document.getElementById("progress-summary");

    if (!scans.length) {
      lastScanText.textContent = "No scans yet. Add your first scan to get started.";
      metricsGrid.innerHTML = "";
      summary.textContent =
        "Once you have at least two scans, you'll see changes in weight, waist, and body fat here.";
      updateAvatar(null);
      return;
    }

    const sorted = [...scans].sort((a, b) => new Date(b.date) - new Date(a.date));
    const latest = sorted[0];
    const previous = sorted[1] || null;

    lastScanText.textContent =
      `Last scan: ${latest.date}${latest.time ? " Â· " + latest.time : ""}`;

    const units = profile.units || "metric";
    const weightUnit = units === "metric" ? "kg" : "lb";

    const bmiLatest = computeBMI(latest.weight, profile.height, units);
    const bmiPrev = previous ? computeBMI(previous.weight, profile.height, units) : null;

    const weightDelta = formatDelta(latest.weight, previous?.weight, true);
    const bfDelta = formatDelta(latest.bodyFat, previous?.bodyFat, true);
    const mmDelta = formatDelta(latest.muscle, previous?.muscle, false);
    const bmiDelta = formatDelta(bmiLatest, bmiPrev, true);

    metricsGrid.innerHTML = `
      <div class="metric-card">
        <h4>Weight</h4>
        <div class="value">${latest.weight ?? "â€”"}<span class="unit">${latest.weight != null ? " " + weightUnit : ""}</span></div>
        <div class="delta ${weightDelta.cls}">${weightDelta.text}</div>
      </div>
      <div class="metric-card">
        <h4>Body fat</h4>
        <div class="value">${latest.bodyFat ?? "â€”"}<span class="unit">${latest.bodyFat != null ? " %" : ""}</span></div>
        <div class="delta ${bfDelta.cls}">${bfDelta.text}</div>
      </div>
      <div class="metric-card">
        <h4>Muscle mass</h4>
        <div class="value">${latest.muscle ?? "â€”"}<span class="unit">${latest.muscle != null ? " " + weightUnit : ""}</span></div>
        <div class="delta ${mmDelta.cls}">${mmDelta.text}</div>
      </div>
      <div class="metric-card">
        <h4>BMI</h4>
        <div class="value">${bmiLatest != null ? bmiLatest.toFixed(1) : "â€”"}</div>
        <div class="delta ${bmiDelta.cls}">${bmiDelta.text}</div>
      </div>
    `;

    if (previous) {
      summary.textContent =
        `You have ${scans.length} total scans. Changes reflect the difference since your previous scan.`;
    } else {
      summary.textContent =
        "You only have one scan so far. As you add more, you'll see trends in your metrics here.";
    }

    updateAvatar(latest.measurements);
  }

  function renderHistory() {
    const tbody = document.getElementById("history-body");
    tbody.innerHTML = "";
    if (!scans.length) {
      const tr = document.createElement("tr");
      tr.classList.add("empty-row");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.textContent = "No scans yet.";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    const units = profile.units || "metric";
    const lengthUnit = units === "metric" ? "cm" : "in";
    const weightUnit = units === "metric" ? "kg" : "lb";

    [...scans]
      .sort((a, b) => new Date(b.date) - new Date(a.date))
      .forEach((scan) => {
        const tr = document.createElement("tr");
        tr.dataset.id = scan.id;
        tr.innerHTML = `
          <td>${scan.date}</td>
          <td>${scan.weight != null ? scan.weight + " " + weightUnit : ""}</td>
          <td>${scan.measurements.waist != null ? scan.measurements.waist + " " + lengthUnit : ""}</td>
          <td>${scan.bodyFat != null ? scan.bodyFat + " %" : ""}</td>
          <td>${shortNotes(scan.notes)}</td>
        `;
        tr.addEventListener("click", () => showDetail(scan.id));
        tbody.appendChild(tr);
      });
  }

  function showDetail(id) {
    const scan = scans.find((s) => s.id === id);
    if (!scan) return;

    const units = profile.units || "metric";
    const lengthUnit = units === "metric" ? "cm" : "in";
    const weightUnit = units === "metric" ? "kg" : "lb";

    document.getElementById("section-detail").classList.remove("hidden");

    const bmi = computeBMI(scan.weight, profile.height, units);
    const summary =
      `${scan.date}${scan.time ? " Â· " + scan.time : ""} Â· ` +
      `${scan.weight != null ? scan.weight + " " + weightUnit : "no weight entered"}` +
      `${bmi != null ? " Â· BMI " + bmi.toFixed(1) : ""}`;
    document.getElementById("detail-summary").textContent = summary;

    const m = scan.measurements;
    const list = document.getElementById("detail-measurements");
    list.innerHTML = `
      <li>Shoulders: ${m.shoulders != null ? m.shoulders + " " + lengthUnit : "â€”"}</li>
      <li>Chest: ${m.chest != null ? m.chest + " " + lengthUnit : "â€”"}</li>
      <li>Waist: ${m.waist != null ? m.waist + " " + lengthUnit : "â€”"}</li>
      <li>Hips: ${m.hips != null ? m.hips + " " + lengthUnit : "â€”"}</li>
      <li>Arms: ${m.arms != null ? m.arms + " " + lengthUnit : "â€”"}</li>
      <li>Thighs: ${m.thighs != null ? m.thighs + " " + lengthUnit : "â€”"}</li>
      <li>Calves: ${m.calves != null ? m.calves + " " + lengthUnit : "â€”"}</li>
    `;

    document.getElementById("detail-notes").textContent = scan.notes || "â€”";

    document.getElementById("detail-front").src = scan.photos.front || "";
    document.getElementById("detail-side").src = scan.photos.side || "";
    document.getElementById("detail-back").src = scan.photos.back || "";
    document.getElementById("detail-angle").src = scan.photos.angle || "";
  }

  function hideDetail() {
    document.getElementById("section-detail").classList.add("hidden");
  }

  function renderProfile() {
    document.getElementById("profile-units").value = profile.units || "metric";
    document.getElementById("profile-height").value = profile.height ?? "";
    document.getElementById("profile-age").value = profile.age ?? "";
    document.getElementById("profile-sex").value = profile.sex ?? "";
    document.getElementById("profile-goal").value = profile.goal ?? "";
  }

  // ===== NAV =====
  function showSection(name) {
    const sections = {
      dashboard: "section-dashboard",
      newscan: "section-newscan",
      history: "section-history",
      profile: "section-profile",
    };
    Object.values(sections).forEach((id) => {
      document.getElementById(id).classList.add("hidden");
    });
    if (sections[name]) {
      document.getElementById(sections[name]).classList.remove("hidden");
    }
    if (name !== "history") hideDetail();

    document.querySelectorAll(".nav-btn").forEach((btn) => {
      btn.classList.toggle("active", btn.dataset.target === name);
    });

    if (name === "dashboard") renderDashboard();
    if (name === "history") renderHistory();
    if (name === "profile") renderProfile();
  }

  // ===== AI ANALYSIS =====
  async function analyzePhotosWithAI() {
    const aiStatus = document.getElementById("ai-status");
    aiStatus.textContent = "";
    const btn = document.getElementById("btn-ai-analyze");
    btn.disabled = true;

    try {
      const height = profile.height;
      const weight = parseFloat(document.getElementById("scan-weight").value);

      const front = document.getElementById("photo-front").files[0];
      const side = document.getElementById("photo-side").files[0];
      const back = document.getElementById("photo-back").files[0];
      const angle = document.getElementById("photo-angle").files[0];

      if (!front || !side) {
        aiStatus.textContent = "AI needs at least front and side photos.";
        btn.disabled = false;
        return;
      }
      if (!height) {
        aiStatus.textContent = "Add your height in Profile for better estimates.";
      } else {
        aiStatus.textContent = "Sending photos to AIâ€¦";
      }

      const formData = new FormData();
      if (height) formData.append("height", height);
      if (!isNaN(weight)) formData.append("weight", weight);
      formData.append("front", front);
      formData.append("side", side);
      if (back) formData.append("back", back);
      if (angle) formData.append("angle", angle);

      const resp = await fetch(API_URL, {
        method: "POST",
        body: formData
      });

      if (!resp.ok) {
        throw new Error("Server error: " + (await resp.text()));
      }

      const data = await resp.json();
      if (!data.ok) {
        throw new Error(data.error || "AI measurement failed.");
      }

      // Map AI outputs into fields we have
      if (data.chest != null) document.getElementById("measure-chest").value = data.chest;
      if (data.waist != null) document.getElementById("measure-waist").value = data.waist;
      if (data.hips != null) document.getElementById("measure-hips").value = data.hips;
      if (data.thigh != null) document.getElementById("measure-thighs").value = data.thigh;
      if (data.arm != null) document.getElementById("measure-arms").value = data.arm;
      // shoulders & calves would come from a richer model later

      aiStatus.textContent =
        `AI filled in some measurements (approx. ${Math.round((data.confidence || 0) * 100)}% confidence). Review and adjust if needed.`;
    } catch (err) {
      console.error(err);
      aiStatus.textContent = "AI error: " + err.message;
    } finally {
      btn.disabled = false;
    }
  }

  // ===== FORM HANDLERS =====
  async function handleNewScan(event) {
    event.preventDefault();
    const date = document.getElementById("scan-date").value;
    if (!date) {
      alert("Please enter a date.");
      return;
    }

    const time = document.getElementById("scan-time").value.trim() || null;
    const weight = parseFloat(document.getElementById("scan-weight").value);
    const bodyFat = parseFloat(document.getElementById("scan-bodyfat").value);
    const muscle = parseFloat(document.getElementById("scan-muscle").value);

    const chest = parseFloat(document.getElementById("measure-chest").value);
    const shoulders = parseFloat(document.getElementById("measure-shoulders").value);
    const waist = parseFloat(document.getElementById("measure-waist").value);
    const hips = parseFloat(document.getElementById("measure-hips").value);
    const arms = parseFloat(document.getElementById("measure-arms").value);
    const thighs = parseFloat(document.getElementById("measure-thighs").value);
    const calves = parseFloat(document.getElementById("measure-calves").value);

    const notes = document.getElementById("scan-notes").value.trim();

    const frontFile = document.getElementById("photo-front").files[0];
    const sideFile = document.getElementById("photo-side").files[0];
    const backFile = document.getElementById("photo-back").files[0];
    const angleFile = document.getElementById("photo-angle").files[0];

    const [front, side, back, angle] = await Promise.all([
      readFileAsDataURL(frontFile),
      readFileAsDataURL(sideFile),
      readFileAsDataURL(backFile),
      readFileAsDataURL(angleFile),
    ]);

    const scan = {
      id: Date.now().toString(),
      date,
      time,
      weight: isNaN(weight) ? null : weight,
      bodyFat: isNaN(bodyFat) ? null : bodyFat,
      muscle: isNaN(muscle) ? null : muscle,
      measurements: {
        chest: isNaN(chest) ? null : chest,
        shoulders: isNaN(shoulders) ? null : shoulders,
        waist: isNaN(waist) ? null : waist,
        hips: isNaN(hips) ? null : hips,
        arms: isNaN(arms) ? null : arms,
        thighs: isNaN(thighs) ? null : thighs,
        calves: isNaN(calves) ? null : calves,
      },
      notes,
      photos: { front, side, back, angle },
    };

    scans.push(scan);
    saveScans();

    event.target.reset();
    document.getElementById("scan-date").value = date;
    document.getElementById("ai-status").textContent = "";

    renderDashboard();
    showSection("dashboard");
  }

  function handleProfileSave(event) {
    event.preventDefault();
    profile.units = document.getElementById("profile-units").value || "metric";
    const heightVal = parseFloat(document.getElementById("profile-height").value);
    const ageVal = parseInt(document.getElementById("profile-age").value, 10);
    profile.height = isNaN(heightVal) ? null : heightVal;
    profile.age = isNaN(ageVal) ? null : ageVal;
    profile.sex = document.getElementById("profile-sex").value || "";
    profile.goal = document.getElementById("profile-goal").value.trim();
    saveProfile();
    alert("Profile saved.");
    renderDashboard();
  }

  // ===== INIT =====
  document.addEventListener("DOMContentLoaded", () => {
    loadData();
    renderDashboard();
    renderProfile();
    renderHistory();

    document.querySelectorAll(".nav-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        showSection(btn.dataset.target);
      });
    });

    document.getElementById("btn-dashboard-newscan").addEventListener("click", () => {
      showSection("newscan");
    });

    document.getElementById("scan-form").addEventListener("submit", handleNewScan);
    document.getElementById("profile-form").addEventListener("submit", handleProfileSave);
    document.getElementById("btn-detail-close").addEventListener("click", hideDetail);

    document.getElementById("btn-ai-analyze").addEventListener("click", analyzePhotosWithAI);

    const today = new Date().toISOString().split("T")[0];
    document.getElementById("scan-date").value = today;
  });
</script>
</body>
</html>
