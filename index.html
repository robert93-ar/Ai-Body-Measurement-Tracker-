<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Body Measurements (Demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-card: #020617;
      --bg-card-soft: #020617;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --accent-strong: rgba(34, 197, 94, 0.35);
      --accent-blue: #38bdf8;
      --accent-blue-soft: rgba(56, 189, 248, 0.12);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-subtle: #1f2937;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617, #020617 55%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .app-shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.75rem 1rem 3rem;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      gap: 0.75rem;
    }

    header h1 {
      font-size: 1.4rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    header h1 span.logo-dot {
      width: 0.6rem;
      height: 0.6rem;
      border-radius: 999px;
      background: radial-gradient(circle, #22c55e, #15803d);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.9);
    }

    header p {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* NAV */
    .nav-tabs {
      display: flex;
      gap: 0.5rem;
      background: rgba(15, 23, 42, 0.7);
      border-radius: 999px;
      padding: 0.25rem;
      border: 1px solid #1e293b;
      margin-bottom: 1.25rem;
      backdrop-filter: blur(12px);
    }

    .nav-tab {
      flex: 1;
      text-align: center;
      font-size: 0.85rem;
      padding: 0.45rem 0.4rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      background: transparent;
      transition: background 0.18s ease, color 0.18s ease, transform 0.08s ease;
      white-space: nowrap;
    }

    .nav-tab.active {
      color: #e5e7eb;
      background: radial-gradient(circle at top, #22c55e, #16a34a);
      box-shadow: 0 0 16px rgba(34, 197, 94, 0.55);
      transform: translateY(-1px);
    }

    .nav-tab:hover:not(.active) {
      background: rgba(31, 41, 55, 0.8);
    }

    /* LAYOUT / CARDS */

    main {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .card {
      background: radial-gradient(circle at top left, #020617, #020617 60%, #000 100%);
      border-radius: 1.2rem;
      border: 1px solid var(--border-subtle);
      padding: 1.2rem 1.2rem 1rem;
      box-shadow:
        0 22px 45px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(148, 163, 184, 0.02);
      position: relative;
      overflow: hidden;
    }

    .card h2 {
      font-size: 1.1rem;
      margin-bottom: 0.15rem;
    }

    .card-subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0.12rem 0.5rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #1f2937;
      color: var(--text-muted);
      gap: 0.3rem;
    }

    /* BUTTONS */

    .btn {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      padding: 0.5rem 0.9rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      gap: 0.3rem;
      transition: background 0.15s ease, transform 0.08s ease, box-shadow 0.15s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: radial-gradient(circle at top, #22c55e, #16a34a);
      color: #ecfdf5;
      box-shadow:
        0 0 22px rgba(34, 197, 94, 0.6),
        0 12px 25px rgba(22, 163, 74, 0.75);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow:
        0 0 28px rgba(34, 197, 94, 0.8),
        0 15px 30px rgba(22, 163, 74, 0.85);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid #374151;
      color: #e5e7eb;
    }

    .btn-outline:hover {
      background: rgba(31, 41, 55, 0.8);
    }

    .btn-sm {
      padding: 0.35rem 0.7rem;
      font-size: 0.78rem;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid #1f2937;
      color: #e5e7eb;
      font-size: 0.78rem;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.9);
    }

    /* DASHBOARD LAYOUT */

    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .dashboard-header-left {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .dashboard-header-left p {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .dashboard-header-right {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
      gap: 1rem;
    }

    .metric-pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.5rem;
    }

    .metric-pill {
      font-size: 0.7rem;
      padding: 0.28rem 0.6rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid #1f2937;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .metric-pill span.value {
      color: #bbf7d0;
      font-weight: 500;
    }

    .metric-pill span.delta-pos {
      color: #4ade80;
      font-size: 0.7rem;
    }

    .metric-pill span.delta-neg {
      color: #f97373;
      font-size: 0.7rem;
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.83rem;
    }

    .muted-strong {
      color: #e5e7eb;
    }

    /* AVATAR: background image + SVG overlay */

    .avatar-card {
      display: grid;
      grid-template-columns: minmax(0, 210px) minmax(0, 1fr);
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.6rem;
    }

    .avatar-wrapper {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0.4rem;
      border-radius: 0.9rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top, #020617, #020617 55%, #000 100%);
      min-height: 250px;
      aspect-ratio: 1 / 1.5;
      overflow: hidden;
      box-shadow:
        0 0 28px rgba(15, 23, 42, 1),
        0 0 36px rgba(56, 189, 248, 0.33);
    }

    #avatar-background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.75;
      object-fit: contain;
      transition: opacity 0.3s ease;
    }

    #measurement-overlay-svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 5;
    }

    .avatar-label {
      position: absolute;
      font-size: 0.7rem;
      color: #e5e7eb;
      white-space: nowrap;
      text-shadow: 0 0 4px rgba(15, 23, 42, 0.9);
    }

    .avatar-label.left {
      left: 6px;
      text-align: left;
    }

    .avatar-label.right {
      right: 6px;
      text-align: right;
    }

    /* approximate vertical positions lining up with the avatar PNG */
    #label-shoulders { top: 16%; }
    #label-chest     { top: 26%; }
    #label-waist     { top: 40%; }
    #label-hips      { top: 52%; }
    #label-thighs    { top: 68%; }
    #label-calves    { top: 82%; }

    .avatar-stats {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .avatar-stats strong {
      font-size: 0.85rem;
      color: #e5e7eb;
    }

    /* FORMS */

    form {
      display: grid;
      gap: 0.75rem;
    }

    .form-grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.84rem;
    }

    .field label {
      color: #e5e7eb;
    }

    .field small {
      color: var(--text-muted);
      font-size: 0.7rem;
    }

    input[type="number"],
    input[type="text"],
    input[type="date"],
    input[type="file"],
    select,
    textarea {
      background: rgba(15, 23, 42, 0.85);
      border-radius: 0.55rem;
      border: 1px solid #1f2937;
      padding: 0.45rem 0.55rem;
      color: #e5e7eb;
      font-size: 0.85rem;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    input::placeholder,
    textarea::placeholder {
      color: #6b7280;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: rgba(34, 197, 94, 0.8);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.45);
    }

    /* HISTORY TABLE */

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }

    thead tr {
      background: rgba(15, 23, 42, 0.9);
    }

    th, td {
      padding: 0.4rem 0.45rem;
      text-align: left;
      border-bottom: 1px solid #111827;
    }

    th {
      font-weight: 500;
      color: #e5e7eb;
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.7);
    }

    .badge-note {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.75rem;
      padding: 0.25rem 0.55rem;
      border-radius: 999px;
      border: 1px solid #1e293b;
      background: rgba(15, 23, 42, 0.75);
      color: var(--text-muted);
      margin-top: 0.4rem;
    }

    .badge-note span.icon {
      font-size: 0.8rem;
      color: #eab308;
    }

    .list {
      margin-top: 0.4rem;
      padding-left: 1rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .list li {
      margin-bottom: 0.18rem;
    }

    .highlight {
      color: #bbf7d0;
      font-weight: 500;
    }

    .danger-text {
      color: var(--danger);
    }

    @media (max-width: 800px) {
      .dashboard-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .avatar-card {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* ---------- PHOTO + CARD MEASUREMENT OVERLAY ---------- */

    .measure-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.92);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 1rem;
    }

    .measure-overlay.active {
      display: flex;
    }

    .measure-panel {
      background: #020617;
      border-radius: 1rem;
      border: 1px solid #1f2937;
      max-width: 640px;
      width: 100%;
      padding: 0.9rem;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .measure-panel h3 {
      font-size: 1rem;
      margin-bottom: 0.1rem;
    }

    .measure-panel p {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    #measure-canvas {
      width: 100%;
      max-height: 60vh;
      border-radius: 0.6rem;
      background: #020617;
      border: 1px solid #1f2937;
      margin-top: 0.4rem;
      cursor: crosshair;
    }

    .measure-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
      flex-wrap: wrap;
      margin-top: 0.4rem;
    }

    .measure-step-label {
      font-size: 0.78rem;
      color: #e5e7eb;
    }

    .measure-tip {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 0.2rem;
    }

    @media (max-width: 640px) {
      .measure-panel {
        height: 100%;
        max-width: 100%;
      }
      #measure-canvas {
        max-height: 55vh;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div>
        <h1>
          <span class="logo-dot"></span>
          AI Body Measurements
        </h1>
        <p>Demo tracker for progress photos & body measurements (imperial units).</p>
      </div>
      <div class="pill">
        <span style="width:6px;height:6px;border-radius:999px;background:#22c55e;box-shadow:0 0 8px rgba(34,197,94,.8);"></span>
        <span>Demo Only · Not medical grade</span>
      </div>
    </header>

    <nav class="nav-tabs">
      <button class="nav-tab active" data-view="dashboard">Dashboard</button>
      <button class="nav-tab" data-view="scan">New scan</button>
      <button class="nav-tab" data-view="history">History</button>
      <button class="nav-tab" data-view="profile">Profile</button>
    </nav>

    <main>
      <!-- DASHBOARD -->
      <section id="view-dashboard" class="view active">
        <div class="card">
          <div class="dashboard-header">
            <div class="dashboard-header-left">
              <h2>Dashboard</h2>
              <p id="dashboard-subtitle">No scans yet. Add your first scan to get started.</p>
            </div>
            <div class="dashboard-header-right">
              <button class="btn btn-primary btn-sm" id="goto-new-scan">
                New Scan →
              </button>
            </div>
          </div>

          <div class="dashboard-grid">
            <!-- LEFT: Avatar -->
            <div>
              <div class="avatar-card">
                <div class="avatar-wrapper">
                  <img
                    id="avatar-background"
                    src="avatar-male.png"
                    alt="3D Body Avatar"
                  />
                  <svg
                    id="measurement-overlay-svg"
                    viewBox="0 0 100 100"
                    preserveAspectRatio="xMidYMid meet">
                  </svg>

                  <div class="avatar-label left"  id="label-shoulders">Shoulders: —</div>
                  <div class="avatar-label left"  id="label-chest">Chest: —</div>
                  <div class="avatar-label left"  id="label-waist">Waist: —</div>

                  <div class="avatar-label right" id="label-hips">Hips: —</div>
                  <div class="avatar-label right" id="label-thighs">Thighs: —</div>
                  <div class="avatar-label right" id="label-calves">Calves: —</div>
                </div>

                <div>
                  <p class="muted">
                    <strong class="muted-strong">Latest body outline</strong><br />
                    These measurement lines sit on top of a 3D avatar and update from your latest scan.
                  </p>
                  <p id="avatar-measurements" class="avatar-stats" style="margin-top:0.5rem;">
                    Add a scan with measurements to see this body map update.
                  </p>
                  <div class="badge-note">
                    <span class="icon">⚠️</span>
                    <span>
                      Future AI or photo-based estimates are
                      <span class="danger-text">not 100% accurate</span>. Always
                      double-check with a tape measure.
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- RIGHT: Metrics -->
            <div>
              <div>
                <h3 style="font-size:0.95rem;margin-bottom:0.25rem;">Latest metrics</h3>
                <p class="muted">A quick snapshot from your most recent scan.</p>
                <div class="metric-pill-row" id="latest-metric-pills" style="margin-top:0.6rem;">
                  <span class="muted">No data yet.</span>
                </div>
              </div>

              <div style="margin-top:0.9rem;">
                <h3 style="font-size:0.95rem;margin-bottom:0.25rem;">Progress summary</h3>
                <p class="muted" id="progress-summary">
                  Once you have at least two scans, you'll see changes in weight, waist, and other key measurements here.
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- MINDSET REMINDER -->
        <div class="card">
          <h2>Mindset & accuracy reminder</h2>
          <p class="card-subtitle">
            This tool is here to support your fitness journey — not to judge it.
          </p>
          <ul class="list">
            <li>All values are in <span class="highlight">imperial units</span> (lbs, inches).</li>
            <li>
              When you use the photo + card helper, the app estimates measurements from a single 2D image.
              These are still estimates and
              <span class="danger-text">may not be fully accurate</span>.
            </li>
            <li>
              Use this app to track trends over time, not to obsess over single numbers.
            </li>
            <li>
              Tape-measure checks every so often are a good way to validate any estimates.
            </li>
          </ul>
        </div>
      </section>

      <!-- NEW SCAN -->
      <section id="view-scan" class="view">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:.75rem;margin-bottom:.55rem;">
            <div>
              <h2>New Scan</h2>
              <p class="card-subtitle">
                Enter your body measurements and optionally attach photos.
              </p>
            </div>
            <span class="pill">Manual entry · Imperial</span>
          </div>

          <form id="scan-form">
            <div class="form-grid-2">
              <div class="field">
                <label for="scan-date">Date</label>
                <input type="date" id="scan-date" name="scanDate" />
              </div>

              <div class="field">
                <label for="weight-lb">Weight (lb)</label>
                <input type="number" id="weight-lb" name="weightLb" min="0" step="0.1" placeholder="e.g. 185" />
              </div>
            </div>

            <div class="form-grid-2">
              <div class="field">
                <label for="shoulders-in">Shoulders (in)</label>
                <input type="number" id="shoulders-in" name="shouldersIn" min="0" step="0.1" />
              </div>
              <div class="field">
                <label for="chest-in">Chest (in)</label>
                <input type="number" id="chest-in" name="chestIn" min="0" step="0.1" />
              </div>
              <div class="field">
                <label for="waist-in">Waist (in)</label>
                <input type="number" id="waist-in" name="waistIn" min="0" step="0.1" />
              </div>
              <div class="field">
                <label for="hips-in">Hips (in)</label>
                <input type="number" id="hips-in" name="hipsIn" min="0" step="0.1" />
              </div>
              <div class="field">
                <label for="thighs-in">Thighs (in)</label>
                <input type="number" id="thighs-in" name="thighsIn" min="0" step="0.1" />
              </div>
              <div class="field">
                <label for="calves-in">Calves (in)</label>
                <input type="number" id="calves-in" name="calvesIn" min="0" step="0.1" />
              </div>
            </div>

            <div class="field">
              <label>Progress photos (optional)</label>
              <small>Front photo with a credit card in view works best for the helper.</small>
            </div>

            <div class="form-grid-2">
              <div class="field">
                <label for="photo-front">Front photo (with card)</label>
                <input type="file" id="photo-front" name="photoFront" accept="image/*" />
              </div>
              <div class="field">
                <label for="photo-side">Side photo</label>
                <input type="file" id="photo-side" name="photoSide" accept="image/*" />
              </div>
              <div class="field">
                <label for="photo-back">Back photo</label>
                <input type="file" id="photo-back" name="photoBack" accept="image/*" />
              </div>
              <div class="field">
                <label for="photo-45">45° photo</label>
                <input type="file" id="photo-45" name="photo45" accept="image/*" />
              </div>
            </div>

            <div class="field">
              <button
                class="btn btn-outline btn-sm"
                type="button"
                id="open-measure-helper">
                Use photo + card helper
              </button>
              <small>
                You’ll click the edges of a credit card, then left/right points for shoulders, chest, waist, hips,
                thighs, and calves. The app will estimate the widths in inches and fill the fields for you.
              </small>
            </div>

            <div class="field">
              <label for="scan-notes">Notes (optional)</label>
              <textarea id="scan-notes" name="scanNotes" placeholder="Workout block, diet changes, how you felt, etc."></textarea>
            </div>

            <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-top:.4rem;">
              <div style="display:flex;gap:.5rem;align-items:center;">
                <button class="btn btn-primary" type="submit">Save scan</button>
              </div>
              <div class="badge-note">
                <span class="icon">ℹ️</span>
                <span>
                  Photo + card helper provides
                  <span class="highlight">estimated</span> measurements only. Adjust them if needed
                  before saving.
                </span>
              </div>
            </div>
          </form>
        </div>
      </section>

      <!-- HISTORY -->
      <section id="view-history" class="view">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:.75rem;margin-bottom:.55rem;">
            <div>
              <h2>History</h2>
              <p class="card-subtitle">
                All stored scans with key measurements in inches and weight in pounds.
              </p>
            </div>
            <button class="btn btn-outline btn-sm" id="clear-history-btn">
              Clear all scans
            </button>
          </div>

          <div id="history-empty" class="muted">
            No scans yet. Once you log scans, they will appear here.
          </div>

          <div id="history-table-wrapper" style="display:none;overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Weight (lb)</th>
                  <th>Shoulders</th>
                  <th>Chest</th>
                  <th>Waist</th>
                  <th>Hips</th>
                  <th>Thighs</th>
                  <th>Calves</th>
                </tr>
              </thead>
              <tbody id="history-tbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="view-profile" class="view">
        <div class="card">
          <h2>Profile & goals</h2>
          <p class="card-subtitle">
            Basic info for this project. Right now this app is tuned for a single male profile.
          </p>

          <form id="profile-form">
            <div class="form-grid-2">
              <div class="field">
                <label for="profile-name">Name</label>
                <input type="text" id="profile-name" name="profileName" placeholder="e.g. Robert" />
              </div>

              <div class="field">
                <label for="profile-height">Height (in)</label>
                <input type="number" id="profile-height" name="profileHeight" min="0" step="0.1" />
              </div>
            </div>

            <div class="form-grid-2">
              <div class="field">
                <label for="goal-weight">Goal weight (lb)</label>
                <input type="number" id="goal-weight" name="goalWeight" min="0" step="0.1" />
              </div>
              <div class="field">
                <label for="goal-waist">Goal waist (in)</label>
                <input type="number" id="goal-waist" name="goalWaist" min="0" step="0.1" />
              </div>
            </div>

            <div class="field">
              <label for="profile-notes">Focus for this phase</label>
              <textarea id="profile-notes" name="profileNotes" placeholder="Lean bulk, recomposition, cut, etc."></textarea>
            </div>

            <button class="btn btn-primary" type="submit" style="margin-top:0.4rem;">
              Save profile
            </button>
          </form>
        </div>
      </section>
    </main>
  </div>

  <!-- PHOTO + CARD MEASUREMENT OVERLAY -->
  <div class="measure-overlay" id="measure-overlay">
    <div class="measure-panel">
      <h3>Photo + Card Measurement Helper</h3>
      <p id="measure-step-text">
        Step 1: Tap the left and right edges of your credit card in the front photo.
      </p>
      <canvas id="measure-canvas"></canvas>
      <div class="measure-controls">
        <span class="measure-step-label" id="measure-step-label">Step 1 of 7</span>
        <div style="display:flex;gap:0.35rem;flex-wrap:wrap;">
          <button class="btn-ghost" type="button" id="measure-clear-step">Clear step</button>
          <button class="btn-ghost" type="button" id="measure-next-step">Skip / next</button>
          <button class="btn-ghost" type="button" id="measure-close">Close</button>
        </div>
      </div>
      <p class="measure-tip">
        Tip: A standard credit card is about <span class="highlight">3.37 inches</span> wide.
        These measurements are estimates based on a 2D image and may not match a tape measure exactly.
      </p>
    </div>
  </div>

  <script>
    // ---------- Simple in-browser "storage" ----------
    const STORAGE_SCANS_KEY = "bodyScans";
    const STORAGE_PROFILE_KEY = "bodyProfile";

    let scans = [];
    let profile = {};

    function loadState() {
      try {
        const scansRaw = localStorage.getItem(STORAGE_SCANS_KEY);
        const profileRaw = localStorage.getItem(STORAGE_PROFILE_KEY);
        scans = scansRaw ? JSON.parse(scansRaw) : [];
        profile = profileRaw ? JSON.parse(profileRaw) : {};
      } catch (e) {
        scans = [];
        profile = {};
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_SCANS_KEY, JSON.stringify(scans));
      localStorage.setItem(STORAGE_PROFILE_KEY, JSON.stringify(profile));
    }

    // ---------- Avatar / measurement visualization ----------

    function updateAvatar(measurements) {
      const svg   = document.getElementById("measurement-overlay-svg");
      const bgImg = document.getElementById("avatar-background");

      // Always use the male avatar image
      bgImg.src = "avatar-male.png";

      // Clear previous lines/dots
      svg.innerHTML = "";

      const unitLabel = "in";
      const lineColor = "#38bdf8";

      const setLabel = (id, name, value) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (value == null || isNaN(value)) {
          el.textContent = name + ": —";
        } else {
          el.textContent = `${name}: ${value} ${unitLabel}`;
        }
      };

      if (!measurements) {
        bgImg.style.opacity = "0.4";
        ["shoulders", "chest", "waist", "hips", "thighs", "calves"].forEach((k) =>
          setLabel("label-" + k, k.charAt(0).toUpperCase() + k.slice(1), null)
        );
        const msgEl = document.getElementById("avatar-measurements");
        if (msgEl) {
          msgEl.textContent =
            "Add a scan with measurements to see this body map update.";
        }
        return;
      }

      bgImg.style.opacity = "0.8";

      const LINE_POSITIONS = {
        shoulders: { Y: 18, X_START: 18, X_END: 82 },
        chest:     { Y: 30, X_START: 20, X_END: 80 },
        waist:     { Y: 46, X_START: 22, X_END: 78 },
        hips:      { Y: 58, X_START: 22, X_END: 78 },
        thighs:    { Y: 74, X_START: 24, X_END: 76 },
        calves:    { Y: 86, X_START: 28, X_END: 72 },
      };

      const drawLine = (name, value) => {
        if (value == null || isNaN(value)) return;
        const pos = LINE_POSITIONS[name];
        if (!pos) return;

        const ns = "http://www.w3.org/2000/svg";

        const line = document.createElementNS(ns, "line");
        line.setAttribute("x1", pos.X_START + "%");
        line.setAttribute("y1", pos.Y + "%");
        line.setAttribute("x2", pos.X_END + "%");
        line.setAttribute("y2", pos.Y + "%");
        line.setAttribute("stroke", lineColor);
        line.setAttribute("stroke-width", "0.8");
        line.setAttribute("stroke-linecap", "round");
        line.setAttribute("stroke-dasharray", "3 2");

        const dot1 = document.createElementNS(ns, "circle");
        dot1.setAttribute("cx", pos.X_START + "%");
        dot1.setAttribute("cy", pos.Y + "%");
        dot1.setAttribute("r", "1.2");
        dot1.setAttribute("fill", lineColor);

        const dot2 = document.createElementNS(ns, "circle");
        dot2.setAttribute("cx", pos.X_END + "%");
        dot2.setAttribute("cy", pos.Y + "%");
        dot2.setAttribute("r", "1.2");
        dot2.setAttribute("fill", lineColor);

        svg.appendChild(line);
        svg.appendChild(dot1);
        svg.appendChild(dot2);
      };

      drawLine("shoulders", measurements.shoulders);
      drawLine("chest",     measurements.chest);
      drawLine("waist",     measurements.waist);
      drawLine("hips",      measurements.hips);
      drawLine("thighs",    measurements.thighs);
      drawLine("calves",    measurements.calves);

      setLabel("label-shoulders", "Shoulders", measurements.shoulders);
      setLabel("label-chest",     "Chest",     measurements.chest);
      setLabel("label-waist",     "Waist",     measurements.waist);
      setLabel("label-hips",      "Hips",      measurements.hips);
      setLabel("label-thighs",    "Thighs",    measurements.thighs);
      setLabel("label-calves",    "Calves",    measurements.calves);

      const parts = [];
      if (measurements.waist != null) parts.push(`waist ${measurements.waist} ${unitLabel}`);
      if (measurements.chest != null) parts.push(`chest ${measurements.chest} ${unitLabel}`);
      if (measurements.hips  != null) parts.push(`hips ${measurements.hips} ${unitLabel}`);

      const msgEl = document.getElementById("avatar-measurements");
      if (msgEl) {
        msgEl.textContent =
          parts.length
            ? `Body map visualized from ${parts.join(" · ")}.`
            : "Body map updated from your latest scan.";
      }
    }

    // ---------- Dashboard metrics & history rendering ----------

    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return "";
      return d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
    }

    function updateDashboard() {
      const subtitleEl = document.getElementById("dashboard-subtitle");
      const metricsContainer = document.getElementById("latest-metric-pills");
      const progressEl = document.getElementById("progress-summary");

      metricsContainer.innerHTML = "";

      if (!scans.length) {
        subtitleEl.textContent = "No scans yet. Add your first scan to get started.";
        metricsContainer.innerHTML = '<span class="muted">No data yet.</span>';
        progressEl.textContent =
          "Once you have at least two scans, you'll see changes in weight, waist, and other key measurements here.";
        updateAvatar(null);
        return;
      }

      const latest = scans[scans.length - 1];
      subtitleEl.textContent = `Last scan: ${formatDate(latest.date)}`;

      const createPill = (label, value, unit, deltaValue) => {
        const span = document.createElement("span");
        span.className = "metric-pill";
        const labelSpan = document.createElement("span");
        labelSpan.textContent = label;
        const valueSpan = document.createElement("span");
        valueSpan.className = "value";
        valueSpan.textContent = value != null ? `${value} ${unit}` : "—";
        span.appendChild(labelSpan);
        span.appendChild(valueSpan);

        if (deltaValue != null && !Number.isNaN(deltaValue) && deltaValue !== 0) {
          const deltaSpan = document.createElement("span");
          deltaSpan.className = deltaValue < 0 ? "delta-neg" : "delta-pos";
          const sign = deltaValue > 0 ? "+" : "";
          deltaSpan.textContent = `(${sign}${deltaValue.toFixed(1)})`;
          span.appendChild(deltaSpan);
        }

        return span;
      };

      let first = scans[0];
      const deltaWeight = (latest.weightLb ?? null) != null && (first.weightLb ?? null) != null
        ? latest.weightLb - first.weightLb
        : null;
      const deltaWaist = (latest.waistIn ?? null) != null && (first.waistIn ?? null) != null
        ? latest.waistIn - first.waistIn
        : null;

      metricsContainer.appendChild(
        createPill("Weight", latest.weightLb ?? null, "lb", deltaWeight)
      );
      metricsContainer.appendChild(
        createPill("Waist", latest.waistIn ?? null, "in", deltaWaist)
      );
      metricsContainer.appendChild(
        createPill("Chest", latest.chestIn ?? null, "in", null)
      );
      metricsContainer.appendChild(
        createPill("Shoulders", latest.shouldersIn ?? null, "in", null)
      );

      if (scans.length >= 2 && deltaWeight != null && deltaWaist != null) {
        const directionWeight = deltaWeight < 0 ? "down" : deltaWeight > 0 ? "up" : "unchanged";
        const directionWaist = deltaWaist < 0 ? "down" : deltaWaist > 0 ? "up" : "unchanged";
        progressEl.textContent =
          `From first to latest scan: weight is ${directionWeight} ` +
          `${deltaWeight.toFixed(1)} lb and waist is ${directionWaist} ` +
          `${Math.abs(deltaWaist).toFixed(1)} in.`;
      } else {
        progressEl.textContent =
          "Once you have at least two scans, you'll see changes in weight and waist over time.";
      }

      updateAvatar({
        shoulders: latest.shouldersIn,
        chest:     latest.chestIn,
        waist:     latest.waistIn,
        hips:      latest.hipsIn,
        thighs:    latest.thighsIn,
        calves:    latest.calvesIn
      });
    }

    function updateHistoryView() {
      const emptyEl = document.getElementById("history-empty");
      const tableWrapper = document.getElementById("history-table-wrapper");
      const tbody = document.getElementById("history-tbody");

      if (!scans.length) {
        emptyEl.style.display = "block";
        tableWrapper.style.display = "none";
        return;
      }

      emptyEl.style.display = "none";
      tableWrapper.style.display = "block";
      tbody.innerHTML = "";

      scans.forEach(scan => {
        const tr = document.createElement("tr");
        const cells = [
          formatDate(scan.date),
          scan.weightLb != null ? scan.weightLb.toFixed(1) : "—",
          scan.shouldersIn ?? "—",
          scan.chestIn ?? "—",
          scan.waistIn ?? "—",
          scan.hipsIn ?? "—",
          scan.thighsIn ?? "—",
          scan.calvesIn ?? "—"
        ];
        cells.forEach(text => {
          const td = document.createElement("td");
          td.textContent = text;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function populateProfileForm() {
      const nameEl = document.getElementById("profile-name");
      const heightEl = document.getElementById("profile-height");
      const goalWeightEl = document.getElementById("goal-weight");
      const goalWaistEl = document.getElementById("goal-waist");
      const notesEl = document.getElementById("profile-notes");

      nameEl.value = profile.name ?? "";
      heightEl.value = profile.heightIn ?? "";
      goalWeightEl.value = profile.goalWeight ?? "";
      goalWaistEl.value = profile.goalWaist ?? "";
      notesEl.value = profile.notes ?? "";
    }

    // ---------- PHOTO + CARD HELPER STATE ----------

    const MEASURE_STEPS = [
      {
        id: "card",
        label: "Card width",
        prompt: "Step 1: Tap the LEFT and RIGHT edges of your credit card.",
        isCalibration: true
      },
      {
        id: "shoulders",
        label: "Shoulders",
        prompt: "Step 2: Tap left and right points at the widest part of your shoulders.",
        targetFieldId: "shoulders-in"
      },
      {
        id: "chest",
        label: "Chest",
        prompt: "Step 3: Tap left and right points across the chest at nipple level.",
        targetFieldId: "chest-in"
      },
      {
        id: "waist",
        label: "Waist",
        prompt: "Step 4: Tap left and right points at the narrowest part of your waist.",
        targetFieldId: "waist-in"
      },
      {
        id: "hips",
        label: "Hips",
        prompt: "Step 5: Tap left and right points at the widest part of your hips.",
        targetFieldId: "hips-in"
      },
      {
        id: "thighs",
        label: "Thighs",
        prompt: "Step 6: Tap left and right points across mid-thigh on your front leg.",
        targetFieldId: "thighs-in"
      },
      {
        id: "calves",
        label: "Calves",
        prompt: "Step 7: Tap left and right points at the fullest part of your calf.",
        targetFieldId: "calves-in"
      }
    ];

    const CREDIT_CARD_WIDTH_IN = 3.37; // inches

    const measureState = {
      img: null,
      pxPerIn: null,
      stepIndex: 0,
      points: []
    };

    function openMeasureOverlay() {
      const overlay = document.getElementById("measure-overlay");
      const canvas = document.getElementById("measure-canvas");
      const fileInput = document.getElementById("photo-front");

      if (!fileInput.files || !fileInput.files[0]) {
        alert("Please select a front photo (with your credit card visible) first.");
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          measureState.img = img;
          measureState.pxPerIn = null;
          measureState.stepIndex = 0;
          measureState.points = [];
          overlay.classList.add("active");
          setupCanvasForImage();
          updateMeasureStepText();
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    function closeMeasureOverlay() {
      const overlay = document.getElementById("measure-overlay");
      overlay.classList.remove("active");
    }

    function setupCanvasForImage() {
      const canvas = document.getElementById("measure-canvas");
      const ctx = canvas.getContext("2d");
      const img = measureState.img;
      if (!img) return;

      // fit image to canvas width while preserving aspect ratio
      const panel = document.querySelector(".measure-panel");
      const maxWidth = panel.clientWidth - 24;
      const ratio = img.height / img.width;

      canvas.width = maxWidth;
      canvas.height = Math.min(maxWidth * ratio, window.innerHeight * 0.55);

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    }

    function redrawCanvasWithCurrentPoints() {
      const canvas = document.getElementById("measure-canvas");
      const ctx = canvas.getContext("2d");
      const img = measureState.img;
      if (!img) return;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      const pts = measureState.points;
      ctx.fillStyle = "#38bdf8";
      ctx.strokeStyle = "#38bdf8";
      ctx.lineWidth = 2;

      pts.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
        ctx.fill();
      });

      if (pts.length === 2) {
        ctx.beginPath();
        ctx.moveTo(pts[0].x, pts[0].y);
        ctx.lineTo(pts[1].x, pts[1].y);
        ctx.setLineDash([6, 4]);
        ctx.stroke();
        ctx.setLineDash([]);
      }
    }

    function updateMeasureStepText() {
      const stepTextEl = document.getElementById("measure-step-text");
      const stepLabelEl = document.getElementById("measure-step-label");
      const step = MEASURE_STEPS[measureState.stepIndex];

      if (!step) return;
      stepTextEl.textContent = step.prompt;
      stepLabelEl.textContent = `Step ${measureState.stepIndex + 1} of ${MEASURE_STEPS.length}`;
    }

    function handleMeasureCanvasClick(evt) {
      const canvas = document.getElementById("measure-canvas");
      const rect = canvas.getBoundingClientRect();
      const x = evt.clientX - rect.left;
      const y = evt.clientY - rect.top;

      const step = MEASURE_STEPS[measureState.stepIndex];
      if (!step) return;

      // collect up to 2 points per step
      if (measureState.points.length >= 2) return;
      measureState.points.push({ x, y });
      redrawCanvasWithCurrentPoints();

      if (measureState.points.length === 2) {
        // compute distance in pixels
        const [p1, p2] = measureState.points;
        const dx = p2.x - p1.x;
        const dy = p2.y - p1.y;
        const distPx = Math.sqrt(dx * dx + dy * dy);

        if (step.isCalibration) {
          // calibration: card width in pixels -> pxPerIn
          measureState.pxPerIn = distPx / CREDIT_CARD_WIDTH_IN;
          alert("Card captured. Scale set from the photo.");
        } else {
          if (!measureState.pxPerIn) {
            alert("Please do the credit-card step first to set the scale.");
          } else if (step.targetFieldId) {
            const inches = distPx / measureState.pxPerIn;
            const rounded = Math.round(inches * 10) / 10;
            const field = document.getElementById(step.targetFieldId);
            if (field) {
              field.value = rounded;
            }
            // update avatar with current field set
            const measurements = {
              shoulders: parseFloat(document.getElementById("shoulders-in").value) || null,
              chest:     parseFloat(document.getElementById("chest-in").value) || null,
              waist:     parseFloat(document.getElementById("waist-in").value) || null,
              hips:      parseFloat(document.getElementById("hips-in").value) || null,
              thighs:    parseFloat(document.getElementById("thighs-in").value) || null,
              calves:    parseFloat(document.getElementById("calves-in").value) || null
            };
            updateAvatar(measurements);
            alert(`${step.label} estimated at ~${rounded} in. You can adjust it before saving.`);
          }
        }

        // move to next step after a short delay
        setTimeout(() => {
          measureState.points = [];
          if (measureState.stepIndex < MEASURE_STEPS.length - 1) {
            measureState.stepIndex += 1;
            setupCanvasForImage();
            updateMeasureStepText();
          } else {
            // finished all steps
            closeMeasureOverlay();
          }
        }, 250);
      }
    }

    function clearCurrentMeasureStep() {
      measureState.points = [];
      setupCanvasForImage();
      updateMeasureStepText();
    }

    function skipMeasureStep() {
      if (measureState.stepIndex < MEASURE_STEPS.length - 1) {
        measureState.stepIndex += 1;
        measureState.points = [];
        setupCanvasForImage();
        updateMeasureStepText();
      } else {
        closeMeasureOverlay();
      }
    }

    // ---------- Event wiring ----------

    document.addEventListener("DOMContentLoaded", () => {
      loadState();
      updateDashboard();
      updateHistoryView();
      populateProfileForm();

      // nav
      document.querySelectorAll(".nav-tab").forEach(btn => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.view;
          document.querySelectorAll(".nav-tab").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
          document.getElementById("view-" + target).classList.add("active");
        });
      });

      const gotoNewScanBtn = document.getElementById("goto-new-scan");
      if (gotoNewScanBtn) {
        gotoNewScanBtn.addEventListener("click", () => {
          document.querySelector('.nav-tab[data-view="scan"]').click();
        });
      }

      // new scan form
      const scanForm = document.getElementById("scan-form");
      const scanDateInput = document.getElementById("scan-date");
      if (scanDateInput && !scanDateInput.value) {
        const today = new Date().toISOString().slice(0, 10);
        scanDateInput.value = today;
      }

      scanForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const formData = new FormData(scanForm);
        const scan = {
          id: Date.now(),
          date: formData.get("scanDate") || new Date().toISOString(),
          weightLb: parseFloat(formData.get("weightLb")) || null,
          shouldersIn: parseFloat(formData.get("shouldersIn")) || null,
          chestIn: parseFloat(formData.get("chestIn")) || null,
          waistIn: parseFloat(formData.get("waistIn")) || null,
          hipsIn: parseFloat(formData.get("hipsIn")) || null,
          thighsIn: parseFloat(formData.get("thighsIn")) || null,
          calvesIn: parseFloat(formData.get("calvesIn")) || null,
          notes: formData.get("scanNotes") || ""
        };

        scans.push(scan);
        saveState();
        updateDashboard();
        updateHistoryView();

        alert("Scan saved!");
        scanForm.reset();
        const today = new Date().toISOString().slice(0, 10);
        scanDateInput.value = today;

        document.querySelector('.nav-tab[data-view="dashboard"]').click();
      });

      // clear history
      const clearBtn = document.getElementById("clear-history-btn");
      clearBtn.addEventListener("click", () => {
        if (!scans.length) return;
        if (confirm("Clear all stored scans? This cannot be undone.")) {
          scans = [];
          saveState();
          updateDashboard();
          updateHistoryView();
        }
      });

      // profile form
      const profileForm = document.getElementById("profile-form");
      profileForm.addEventListener("submit", (e) => {
        e.preventDefault();
        profile = {
          name: document.getElementById("profile-name").value || "",
          heightIn: parseFloat(document.getElementById("profile-height").value) || null,
          goalWeight: parseFloat(document.getElementById("goal-weight").value) || null,
          goalWaist: parseFloat(document.getElementById("goal-waist").value) || null,
          notes: document.getElementById("profile-notes").value || ""
        };
        saveState();
        alert("Profile saved.");
      });

      // photo + card helper
      const openHelperBtn = document.getElementById("open-measure-helper");
      const overlay = document.getElementById("measure-overlay");
      const canvas = document.getElementById("measure-canvas");

      if (openHelperBtn) {
        openHelperBtn.addEventListener("click", openMeasureOverlay);
      }

      if (canvas) {
        canvas.addEventListener("click", handleMeasureCanvasClick);
      }

      const clearStepBtn = document.getElementById("measure-clear-step");
      const nextStepBtn = document.getElementById("measure-next-step");
      const closeBtn = document.getElementById("measure-close");

      if (clearStepBtn) {
        clearStepBtn.addEventListener("click", clearCurrentMeasureStep);
      }
      if (nextStepBtn) {
        nextStepBtn.addEventListener("click", skipMeasureStep);
      }
      if (closeBtn) {
        closeBtn.addEventListener("click", closeMeasureOverlay);
      }

      // re-draw canvas on window resize (keep image fitting nicely)
      window.addEventListener("resize", () => {
        if (overlay.classList.contains("active") && measureState.img) {
          setupCanvasForImage();
          measureState.points = [];
        }
      });
    });
  </script>
</body>
</html>
